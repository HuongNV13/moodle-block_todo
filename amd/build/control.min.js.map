{"version":3,"file":"control.min.js","sources":["../src/control.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides the block_todo/control module\n *\n * @package     block_todo\n * @category    output\n * @copyright   2018 David Mudr√°k <david@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module block_todo/control\n */\ndefine(['jquery', 'core/log', 'core/ajax', 'core/templates', 'core/str'], function($, Log, Ajax, Templates, Str) {\n    'use strict';\n\n    /**\n     * Initializes the block controls.\n     */\n    function init(instanceid, contextid) {\n        Log.debug('block_todo/control: initializing controls of the todo block instance ' + instanceid);\n\n        var region = $('[data-region=\"block_todo-instance-' + instanceid +'\"]').first();\n\n        if (!region.length) {\n            Log.error('block_todo/control: wrapping region not found!');\n            return;\n        }\n\n        var control = new TodoControl(region, instanceid, contextid);\n        control.main();\n    }\n\n    /**\n     * Controls a single ToDo block instance contents.\n     *\n     * @constructor\n     * @param {jQuery} region\n     * @param {int} instanceid\n     * @param {int} contextid\n     */\n    function TodoControl(region, instanceid, contextid) {\n        var self = this;\n        self.region = region;\n        self.instanceid = instanceid;\n        self.contextid = contextid;\n    }\n\n    /**\n     * Run the controller.\n     *\n     */\n    TodoControl.prototype.main = function () {\n        var self = this;\n\n        self.addTextForm = self.region.find('[data-control=\"addform\"]').first();\n        self.addTextInput = self.addTextForm.find('input.block_todo_text').first();\n        self.addDueDateInput = self.addTextForm.find('input.block_todo_duedate').first();\n        self.addTextButton = self.addTextForm.find('button').first();\n        self.itemsList = self.region.find('ul').first();\n        self.sortActions = self.region.find('.block_todo_sort .block_todo_sort_item');\n\n        self.initAddFeatures();\n        self.initEditFeatures();\n        self.initSortFeatures();\n        self.getItems('createddate');\n    };\n\n    /**\n     * Initialize the controls for adding a new todo item.\n     *\n     * @method\n     */\n    TodoControl.prototype.initAddFeatures = function () {\n        var self = this;\n\n        self.addTextForm.on('submit', function(e) {\n            e.preventDefault();\n            self.addNewTodo();\n            window.console.log('aa');\n        });\n\n        self.addTextButton.on('click', function() {\n            self.addTextForm.submit();\n        });\n    };\n\n    /**\n     * Initialize the controls for modifying existing items.\n     *\n     * @method\n     */\n    TodoControl.prototype.initEditFeatures = function () {\n        var self = this;\n\n        self.itemsList.on('click', '[data-item]', function(e) {\n            e.preventDefault();\n            e.stopPropagation();\n            var id = $(e.currentTarget).attr('data-item');\n            self.toggleItem(id);\n        });\n\n        self.itemsList.on('click', '[data-control=\"delete\"]', function(e) {\n            e.preventDefault();\n            e.stopPropagation();\n            var id = $(e.currentTarget).closest('[data-item]').attr('data-item');\n            self.deleteItem(id);\n        });\n    };\n\n    /**\n     * Initialize the controls for sorting items.\n     *\n     * @method\n     */\n    TodoControl.prototype.initSortFeatures = function() {\n        const self = this;\n\n        self.sortActions.on('click', (e) => {\n            e.preventDefault();\n            const sortBy = $(e.currentTarget).attr('data-sort');\n            self.getItems(sortBy);\n        });\n    };\n\n    /**\n     * Add a new todo item.\n     *\n     * @method\n     * @return {Deferred}\n     */\n    TodoControl.prototype.addNewTodo = function () {\n        var self = this;\n        var text = $.trim(self.addTextInput.val());\n        let args = {\n            duedate: null\n        };\n        const duedate = $.trim(self.addDueDateInput.val());\n\n        if (!text) {\n            return Str.get_string('placeholdermore', 'block_todo').then(function(text) {\n                self.addTextInput.prop('placeholder', text);\n                return $.Deferred().resolve();\n            });\n        }\n\n        if (duedate) {\n            args.duedate = Math.floor(new Date(duedate).getTime() / 1000);\n        }\n\n        self.addTextInput.prop('disabled', true);\n\n        args.todotext = text;\n\n        return Ajax.call([{\n            methodname: 'block_todo_add_item',\n            args: args\n\n        }])[0].fail(function(reason) {\n            Log.error('block_todo/control: unable to add the item');\n            Log.debug(reason);\n            self.addTextButton.addClass('btn-danger');\n            self.addTextButton.html('<i class=\"fa fa-exclamation-circle\" aria-hidden=\"true\"></i>');\n            return $.Deferred().reject();\n\n        }).then(function(response) {\n            return Templates.render('block_todo/item', response).fail(function(reason) {\n                Log.error('block_todo/control: unable to render the new item:' + reason);\n            });\n\n        }).then(function(item) {\n            self.itemsList.prepend(item);\n            self.addTextInput.val('');\n            self.addTextInput.prop('disabled', false);\n            self.addTextInput.focus();\n            return $.Deferred().resolve();\n        });\n    };\n\n    /**\n     * Toggle the done status of the given item.\n     *\n     * @method\n     * @return {Deferred}\n     */\n    TodoControl.prototype.toggleItem = function (id) {\n        var self = this;\n\n        if (!id) {\n            return $.Deferred().resolve();\n        }\n\n        return Ajax.call([{\n            methodname: 'block_todo_toggle_item',\n            args: {\n                id: id\n            }\n\n        }])[0].fail(function(reason) {\n            Log.error('block_todo/control: unable to toggle the item');\n            Log.debug(reason);\n            return $.Deferred().reject();\n\n        }).then(function(response) {\n            return Templates.render('block_todo/item', response).fail(function(reason) {\n                Log.error('block_todo/control: unable to render the new item:' + reason);\n            });\n\n        }).then(function(item) {\n            self.itemsList.find('[data-item=\"' + id + '\"]').replaceWith(item);\n            return $.Deferred().resolve();\n        });\n    };\n\n    /**\n     * Delete the given item.\n     *\n     * @method\n     * @return {Deferred}\n     */\n    TodoControl.prototype.deleteItem = function (id) {\n        var self = this;\n\n        if (!id) {\n            return $.Deferred().resolve();\n        }\n\n        return Ajax.call([{\n            methodname: 'block_todo_delete_item',\n            args: {\n                id: id\n            }\n\n        }])[0].fail(function(reason) {\n            Log.error('block_todo/control: unable to delete the item');\n            Log.debug(reason);\n            return $.Deferred().reject();\n\n        }).then(function(deletedid) {\n            self.itemsList.find('[data-item=\"' + deletedid + '\"]').remove();\n            return $.Deferred().resolve();\n        });\n    };\n\n    /**\n     * Get items.\n     *\n     * @method\n     * @return {Deferred}\n     */\n    TodoControl.prototype.getItems = function(sortBy) {\n        var self = this;\n\n        return Ajax.call([{\n            methodname: 'block_todo_get_items',\n            args: {\n                instanceid: self.instanceid,\n                contextid: self.contextid,\n                sort: sortBy,\n            }\n\n        }])[0].fail(function(reason) {\n            Log.error('block_todo/control: unable to delete the item');\n            Log.debug(reason);\n            return $.Deferred().reject();\n\n        }).then(function(response) {\n            return Templates.render('block_todo/items', response).fail(function(reason) {\n                Log.error('block_todo/control: unable to render items:' + reason);\n            });\n\n        }).then(function(items) {\n            self.region.find('.items-list').html(items);\n            return $.Deferred().resolve();\n        });\n    };\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","Log","Ajax","Templates","Str","TodoControl","region","instanceid","contextid","this","prototype","main","addTextForm","find","first","addTextInput","addDueDateInput","addTextButton","itemsList","sortActions","initAddFeatures","initEditFeatures","initSortFeatures","getItems","self","on","e","preventDefault","addNewTodo","window","console","log","submit","stopPropagation","id","currentTarget","attr","toggleItem","closest","deleteItem","sortBy","text","trim","val","args","duedate","Math","floor","Date","getTime","prop","todotext","call","methodname","fail","reason","error","debug","addClass","html","Deferred","reject","then","response","render","item","prepend","focus","resolve","get_string","replaceWith","deletedid","remove","sort","items","init","length"],"mappings":"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"}